<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goede doelen dag Hades</title>
    <link rel="icon" type="image/png" href="/hades.png">
    <link rel="stylesheet" href="main.css">
</head>

<body>
    <div class="container">
        <button id="password-btn" onclick="showKeyPopup()"><img src="key.svg" alt=""></button>
        <h2>Loten Registreren</h2>
        <form id="addRowForm">
            <div class="form-group">
                <label for="name">Naam:</label>
                <input type="text" id="name" name="name" required autocomplete="off">
            </div>
            <div class="form-group">
                <label for="address">Straat en huisnummer:</label>
                <input type="text" id="address" name="address" required autocomplete="off" onfocus="showSuggestion()"
                    onblur="handleBlur()" pattern="(?=.*\d).*">
            </div>
            <div id="suggestionBubble">
                <button type="button" onclick="acceptSuggestion()" id="suggestionText"
                    onmousedown="ignoreNextBlur = true;">Laatst gebruikt: </button>
            </div>
            <div class="form-group">
                <label for="amount">Hoeveelheid:</label>
                <input type="number" id="amount" name="amount" min="1" required autocomplete="off">
            </div>
            <button class="submit" type="submit" id="submit-btn">Registreren</button>
            <button class="reset" type="reset" id="reset-btn">Wissen</button>
        </form>


        <div id="response"></div>
        <div id="loten" class="loten"></div>
    </div>

    <script src="apiKey.js"></script>
    <script src="api.js"></script>
    <script src="addressSuggestion.js"></script>

    <script>
        const form = document.getElementById('addRowForm');
        const responseDiv = document.getElementById('response');
        const lotenDiv = document.getElementById('loten')
        const openPopupBtn = document.getElementById('password-btn')
        const submintBtn = document.getElementById('submit-btn')
        const resetBtn = document.getElementById('reset-btn')

        // Set custom hints for when the form is not valid
        form.addEventListener('invalid', function (event) {
            const input = event.target;

            input.setCustomValidity('');

            if (!input.validity.valid) {

                if (input.validity.valueMissing) {
                    input.setCustomValidity('Dit veld is verplicht.');
                }

                else if (input.id === 'address' && input.validity.patternMismatch) {
                    input.setCustomValidity('Het huisnummer mist.');
                }
            }
        }, true);

        // Remove hint when the input is changed
        form.addEventListener('input', function (event) {
            event.target.setCustomValidity('');
        });

        // Submit form when button is clicked
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            setResetDisabled(true)
            setSubmitDisabled(true)
            saveSuggestion()

            responseDiv.textContent = 'Wachten op loten...';

            const name = document.getElementById('name').value;
            const address = document.getElementById('address').value;
            const amount = parseInt(document.getElementById('amount').value, 10);

            const data = await postData(name, address, amount);
            console.log(data)

            if (typeof data !== 'string') {
                responseDiv.textContent = "Uw loten:"
                let shortName = name;
                if (shortName.length > 20) {
                    shortName = shortName.slice(0, 17) + '...';
                }
                data.forEach(n => {
                    createLotDiv(n, shortName)
                });
                setResetDisabled(false)
            } else {
                responseDiv.textContent = `${data || 'Unknown error'}`;
                setSubmitDisabled(false)
                setResetDisabled(false)
            }
        });

        // reset page when button is clicked
        form.addEventListener('reset', e => {
            form.reset()
            lotenDiv.innerHTML = ''
            responseDiv.textContent = ''
            setSubmitDisabled(false)
        })

        /**
         * Add a div for a lot
         */
        function createLotDiv(number, shortName) {
            const div = document.createElement('div');
            div.innerHTML = '<p class="name">' + shortName + '</p><p class="number">' + String(number).padStart(4, '0') + '</p>'
            div.classList.add('lot')
            lotenDiv.append(div)
        }

        /**
         * Disable or enable the submit button
         */
        function setSubmitDisabled(disabled) {
            if (disabled) {
                submintBtn.disabled = true;
                submintBtn.style.backgroundColor = "#666666"
            } else {
                submintBtn.disabled = false;
                submintBtn.style.backgroundColor = "#4CAF50"
            }
        }
        /**
         * Disable or enable the reset button
         */
        function setResetDisabled(disabled) {
            if (disabled) {
                resetBtn.disabled = true;
                resetBtn.style.backgroundColor = "#666666"
            } else {
                resetBtn.disabled = false;
                resetBtn.style.backgroundColor = "#FF3C3C"
            }
        }
    </script>

</body>

</html>